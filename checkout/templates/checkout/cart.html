{% extends "base.html" %} {% load static %} {% block content %}
<div class="row">
  <h1>It works!</h1>
  <div class="col s12">
    {% if cart_items %}
    <table>
      <thead>
        <tr>
          <th>Mug Info</th>
          <th></th>
          <th>Price</th>
          <th>Qty</th>
          <th>Subtotal</th>
        </tr>
      </thead>

      <tbody>
        {% for item in cart_items %}
        <tr>
          <td>
            <img src="{{ item.mug.image.url }}">
          </td>
          <td>
            <p><strong>{{ item.mug.name }}</strong></p>
            <p>SKU: {{ item.mug.sku|upper }}</p>
          </td>
          <td>
            <p>${{ item.mug.price }}</p>
          </td>
          <td>
            <form class="update-form" method="POST" action="">
                {% csrf_token %}
                <div class="row">
                    <div class="input-field col">
                        <input
                        id="first_name"
                        type="number"
                        name="quantity"
                        value="{{ item.quantity }}"
                        min="1"
                        max="99"
                        data-item_id="{{ item.item_id }}"
                        id="id_qty_{{ item.item_id }}"
                        class="validate"
                        />
                        <label for="quantity">Quantity</label>
                    </div>
                </div>
                <a class="update-link"><small>Update</small></a>
                <a class="remove-item right" id="remove_{{ item.item_id }}"><small>Remove</small></a>
            </form>
          </td>
          <td>
            <p>${{ item.mug.price }}</p>
          </td>
        </tr>
        {% endfor %}
        <tr>
          <td>
            <p>Cart Total: ${{ total|floatformat:2 }}</p>
            <p>Delivery: ${{ delivery|floatformat:2 }}</p>
            <p>Grand Total: ${{ grand_total|floatformat:2 }}</p>
            {% if free_delivery_delta > 0 %}
                <p>You could get free delivery by spending just <strong>${{ free_delivery_delta }}</strong> more!</p>
            {% endif %}
          </td>
        </tr>
        <tr>
            <td>
                <a href="{% url 'mugs' %}" class="waves-effect waves-light btn">Keep Shopping</a>
                <a href="{% url 'mugs' %}" class="waves-effect waves-light btn"><i class="material-icons">lock</i>Secure Checkout</a>
            </td>
        </tr>
      </tbody>
    </table>
    {% else %}
    <p>Your bag is empty.</p>
    <a href="{% url 'mugs' %}" class="waves-effect waves-light btn">Keep Shopping</a>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block postloadjs %}
{{ block.super }}

<script type="text/javascript">
    // Update quantity on click
    $('.update-link').click(function(e) {
        var form = $(this).prev('.update-form');
        form.submit();
    })

    // Remove item and reload on click
    $('.remove-item').click(function(e) {
        var csrfToken = "{{ csrf_token }}";
        var itemId = $(this).attr('id').split('remove_')[1];
        var size = $(this).data('size');
        var url = `/cart/remove/${itemId}`;
        var data = {'csrfmiddlewaretoken': csrfToken, 'size': size};

        $.post(url, data)
         .done(function() {
             location.reload();
         });
    })
</script>
{% endblock %}